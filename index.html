<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Museum Object Records Demo with AAT Lookup</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display:block; margin-top: 10px; }
    input, button { padding: 6px; font-size: 1rem; }
    #status { margin-top: 15px; font-style: italic; color: #333; font-weight: bold; }
    #objectNamesList p { cursor: pointer; color: blue; text-decoration: underline; }
    #recordsTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
    #recordsTable th, #recordsTable td { border: 1px solid #ccc; padding: 8px; }
    #recordsTable th { background-color: #f0f0f0; }
    #columns { display: flex; gap: 50px; }
    #listColumn { flex: 1; }
    #tableColumn { flex: 2; }
  </style>
</head>
<body>
  <h1>Museum Object Records Demo with AAT Lookup</h1>

  <p>Enter your MuseumData.uk API token and an object name (or keyword). The token is stored only in memory and clears when the page reloads.</p>

  <label>API Token:<br>
    <input id="token" type="password" placeholder="Enter API token" />
  </label>

  <label>Search Term (object name):<br>
    <input id="objectName" type="text" placeholder="e.g. sceatta, brooch, vase..." />
  </label>

  <button id="runBtn">Fetch Records</button>

  <div id="status">Status will appear here...</div>

  <div id="columns">
    <div id="listColumn">
      <h2>Object Names</h2>
      <div id="objectNamesList"></div>
    </div>
    <div id="tableColumn">
      <h2>Records</h2>
      <table id="recordsTable">
        <thead>
          <tr>
            <th>Object Names</th>
            <th>Title</th>
            <th>Collection</th>
            <th>AAT PID</th>
            <th>Full Record</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const AAT_SPARQL_ENDPOINT = "https://vocab.getty.edu/sparql";
    const aatCache = {}; // simple in-memory cache for AAT PIDs

    async function fetchAllRecords(token, objectName) {
      statusEl.textContent = 'Fetching records...';
      let allData = [];
      let url = `https://mds-data.ciim.k-int.com/api/v2/search?q=${encodeURIComponent(objectName)}&field=${encodeURIComponent('object_name:' + objectName)}`;

      while (url) {
        const res = await fetch(url, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error('API request failed: ' + res.status + ' ' + (await res.text()));
        }

        const data = await res.json();
        allData = allData.concat(data.data || []);
        statusEl.textContent = `Fetched ${allData.length} of ${data.stats.total} records...`;
        url = data.navigation?.next || null;
      }

      statusEl.textContent = `All ${allData.length} records fetched.`;
      return allData;
    }

    function extractObjectNames(records) {
      const freq = {};
      for (const rec of records) {
        const names = rec?.summary?.object_name || [];
        for (const name of names) {
          const cleanName = name.trim();
          if (cleanName) freq[cleanName] = (freq[cleanName] || 0) + 1;
        }
      }
      return freq;
    }

    function renderList(freqMap, records) {
      const container = document.getElementById('objectNamesList');
      container.innerHTML = '';
      Object.entries(freqMap)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, count]) => {
          const p = document.createElement('p');
          p.textContent = `${name} (${count})`;
          p.addEventListener('click', () => renderTable(name, records));
          container.appendChild(p);
        });
    }

    async function getAatPid(term) {
      // Check cache first
      if (aatCache[term]) return aatCache[term];

      const query = `
        PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
        PREFIX aat: <http://vocab.getty.edu/aat/>
        SELECT ?term ?pid WHERE {
          ?term a skos:Concept ;
                skos:inScheme aat: ;
                (skos:prefLabel|skos:altLabel) ?label .
          FILTER(LCASE(STR(?label)) = LCASE("${term}"))
          BIND(STRAFTER(STR(?term), "http://vocab.getty.edu/aat/") AS ?pid)
        }
        LIMIT 1
      `;
      const url = AAT_SPARQL_ENDPOINT + "?query=" + encodeURIComponent(query);
      try {
        const res = await fetch(url, { headers: { "Accept": "application/sparql-results+json" } });
        if (!res.ok) return null;
        const data = await res.json();
        const bindings = data.results.bindings;
        const pid = bindings.length ? bindings[0].pid.value : null;
        aatCache[term] = pid || 'No match';
        return aatCache[term];
      } catch (err) {
        console.error('AAT lookup error for term:', term, err);
        aatCache[term] = 'Error';
        return 'Error';
      }
    }

    async function renderTable(objectName, records) {
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = '';

      const filtered = records.filter(rec => rec?.summary?.object_name?.includes(objectName));
      for (const rec of filtered) {
        const tr = document.createElement('tr');

        // Object Names
        const objNames = document.createElement('td');
        objNames.textContent = (rec.summary.object_name || []).join(', ');
        tr.appendChild(objNames);

        // Title
        const title = document.createElement('td');
        title.textContent = (rec.summary.title || []).join(', ');
        tr.appendChild(title);

        // Collection
        const collection = document.createElement('td');
        collection.textContent = (rec.summary.collection || []).join(', ');
        tr.appendChild(collection);

        // AAT PID
        const aatTd = document.createElement('td');
        const firstName = (rec.summary.object_name || [])[0]; // first object name
        aatTd.textContent = 'Loading...';
        tr.appendChild(aatTd);

        // Full record link
        const linkTd = document.createElement('td');
        const link = document.createElement('a');
        link.href = `https://museumdata.uk/object-search/object/?pid=${(rec.summary.pid || [])[0]}`;
        link.textContent = 'Full record';
        link.target = '_blank';
        linkTd.appendChild(link);
        tr.appendChild(linkTd);

        tbody.appendChild(tr);

        // Fetch AAT PID asynchronously with caching
        if (firstName) {
          getAatPid(firstName).then(pid => {
            aatTd.textContent = pid;
          });
        } else {
          aatTd.textContent = 'No name';
        }
      }
    }

    document.getElementById('runBtn').addEventListener('click', async () => {
      const token = document.getElementById('token').value.trim();
      const objectName = document.getElementById('objectName').value.trim();

      if (!token || !objectName) {
        alert('Please enter both token and a search term.');
        return;
      }

      try {
        const records = await fetchAllRecords(token, objectName);
        if (records.length === 0) {
          statusEl.textContent = 'No records found for this search.';
          return;
        }

        const freqMap = extractObjectNames(records);
        renderList(freqMap, records);
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
        console.error(e);
      }
    });
  </script>
</body>
</html>
