<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Museum Object Word Cloud Demo</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #cloud { width: 800px; height: 500px; border: 1px solid #ddd; margin-top: 20px; }
    label { display:block; margin-top: 10px; }
    input, button { padding: 6px; font-size: 1rem; }
    #status { margin-top: 15px; font-style: italic; color: #333; font-weight: bold; }
    #objectNamesList { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Museum Object Word Cloud Demo</h1>

  <p>Enter your MuseumData.uk API token and an object name (or keyword). The token is stored only in memory and clears when the page reloads.</p>

  <label>API Token:<br>
    <input id="token" type="password" placeholder="Enter API token" />
  </label>

  <label>Search Term (object name):<br>
    <input id="objectName" type="text" placeholder="e.g. sceatta, brooch, vase..." />
  </label>

  <button id="runBtn">Generate Word Cloud</button>

  <div id="status">Status will appear here...</div>
  <div id="cloud"></div>
  <div id="objectNamesList"></div>

  <script>
    const statusEl = document.getElementById('status');

    async function fetchAllRecords(token, objectName) {
      statusEl.textContent = 'Fetching records...';
      let allData = [];
      let url = `https://mds-data.ciim.k-int.com/api/v2/search?q=${encodeURIComponent(objectName)}&field=${encodeURIComponent('object_name:' + objectName)}`;

      while (url) {
        const res = await fetch(url, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!res.ok) {
          throw new Error('API request failed: ' + res.status + ' ' + (await res.text()));
        }

        const data = await res.json();
        allData = allData.concat(data.data || []);
        statusEl.textContent = `Fetched ${allData.length} of ${data.stats.total} records...`;
        url = data.navigation?.next || null;
      }

      statusEl.textContent = `All ${allData.length} records fetched.`;
      return allData;
    }

    function extractObjectNames(records) {
      const freq = {};
      for (const rec of records) {
        const names = rec?.summary?.object_name || [];
        for (const name of names) {
          const cleanName = name.trim();
          if (cleanName) freq[cleanName] = (freq[cleanName] || 0) + 1;
        }
      }
      return freq;
    }

    function renderWordCloud(freqMap) {
      statusEl.textContent = 'Building word cloud...';
      document.getElementById('cloud').innerHTML = '';

      const entries = Object.entries(freqMap)
        .map(([text, count]) => ({ text, size: 10 + count * 10 }));

      if (entries.length === 0) {
        statusEl.textContent = 'No object names to display in the cloud.';
        return;
      }

      const layout = d3.layout.cloud()
        .size([800, 500])
        .words(entries)
        .padding(2)
        .rotate(() => ~~(Math.random() * 2) * 90)
        .font('sans-serif')
        .fontSize(d => d.size)
        .on('end', words => {
          const svg = d3.select('#cloud').append('svg')
            .attr('width', 800)
            .attr('height', 500)
            .append('g')
            .attr('transform', 'translate(400,250)');

          svg.selectAll('text')
            .data(words)
            .enter().append('text')
            .style('font-size', d => d.size + 'px')
            .style('font-family', 'sans-serif')
            .style('fill', () => `hsl(${Math.random() * 360},70%,50%)`)
            .attr('text-anchor', 'middle')
            .attr('transform', d => `translate(${[d.x, d.y]})rotate(${d.rotate})`)
            .text(d => d.text);

          statusEl.textContent = 'Word cloud generated.';
        });

      setTimeout(() => layout.start(), 0);
    }

    function renderList(freqMap) {
      const container = document.getElementById('objectNamesList');
      container.innerHTML = '';
      Object.entries(freqMap)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, count]) => {
          const p = document.createElement('p');
          p.textContent = `${name} (${count})`;
          container.appendChild(p);
        });
    }

    document.getElementById('runBtn').addEventListener('click', async () => {
      const token = document.getElementById('token').value.trim();
      const objectName = document.getElementById('objectName').value.trim();

      if (!token || !objectName) {
        alert('Please enter both token and a search term.');
        return;
      }

      try {
        const data = await fetchAllRecords(token, objectName);
        if (data.length === 0) {
          statusEl.textContent = 'No records found for this search.';
          return;
        }

        const freqMap = extractObjectNames(data);
        renderWordCloud(freqMap);
        renderList(freqMap);
      } catch (e) {
        statusEl.textContent = 'Error: ' + e.message;
        console.error(e);
      }
    });
  </script>
</body>
</html>
